services:
  # Infrastructure Services
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: td8-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  redis:
    image: redis:latest
    container_name: td8-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]

  mongodb:
    image: mongo:8.0
    container_name: td8-mongo
    volumes:
      - mongodb_data:/data/db

  # Micro Services
  auth:
    container_name: td8-auth
    build:
      context: auth
      dockerfile: Dockerfile.dev
    ports:
      - "3000:80"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/
      - MONGO_DB=authdb
      - JWT_SECRET=your-super-secret-key-change-in-production
      - USERS_SERVICE_URL=http://users:80
    volumes:
      - ./auth/src:/app/src
    depends_on:
      - mongodb
      - users
      - rabbitmq

  users:
    container_name: td8-users
    build:
      context: users
      dockerfile: Dockerfile.dev
    ports:
      - "3001:80"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/
      - MONGO_DB=usersdb
    volumes:
      - ./users/src:/app/src
      - users_uploads:/app/uploads
    depends_on:
      - mongodb
      - rabbitmq

  posts:
    container_name: td8-posts
    build:
      context: posts
      dockerfile: Dockerfile.dev
    ports:
      - "3002:80"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/
      - MONGO_DB=postsdb
    volumes:
      - ./posts/src:/app/src
      - posts_uploads:/app/uploads
    depends_on:
      - mongodb

  groups:
    container_name: td8-groups
    build:
      context: groups
      dockerfile: Dockerfile.dev
    ports:
      - "3003:80"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/
      - MONGO_DB=groupsdb
      - REDIS_HOST=redis
      - RABBIT_URL=amqp://rabbitmq
      - RABBIT_EXCHANGE=groups.events
    volumes:
      - ./groups/src:/app/src
    depends_on:
      - users
      - mongodb
      - redis
      - rabbitmq

  front:
    container_name: td8-front
    build:
      context: front
      dockerfile: Dockerfile.dev
    ports:
      - "5173:80"
    volumes:
      - ./front:/app
      - /app/node_modules
    depends_on:
      - auth
      - users
      - posts
      - groups

  notifier:
    container_name: td8-notifier
    build:
      context: notifier
      dockerfile: Dockerfile.dev
    ports:
      - "3004:80"
    environment:
      - RABBIT_URL=amqp://rabbitmq
      - RABBIT_EXCHANGE=groups.events
    volumes:
      - ./notifier/src:/app/src
    depends_on:
      - rabbitmq

  reverseproxy:
    container_name: td8-reverse
    build:
      context: reverse-proxy
      dockerfile: Dockerfile.dev
    depends_on:
      - auth
      - users
      - posts
      - groups
    volumes:
      - ./reverse-proxy/log:/var/log/nginx
    ports:
      - "8080:80"

  messages:
    container_name: td8-messages
    build:
      context: messages
      dockerfile: Dockerfile.dev
    ports:
      - "3005:80"
    environment:
      - MONGO_URI=mongodb://mongodb:27017/
      - MONGO_DB=messagesdb
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PORT=80
    volumes:
      - ./messages/src:/app/src
    depends_on:
      - mongodb
      - redis
      - rabbitmq

  # Dans docker-compose.yml, ajouter dans la section "Micro Services"

  email:
    container_name: td8-email
    build:
      context: email
      dockerfile: Dockerfile.dev
    ports:
      - "3006:80"
    environment:
      - PORT=80
      - RABBIT_URL=amqp://rabbitmq
      - BREVO_API_KEY=${SENDINBLUE_API_KEY}
      - FROM_EMAIL=projetweb.noreply@gmail.com
      - FROM_NAME=Projet Web
      - APP_URL=http://localhost:8080
    volumes:
      - ./email/src:/app/src
    depends_on:
      - rabbitmq

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  users_uploads:
  posts_uploads:
